{{ $page := . }}

{{ $breadcrumbs := $page.Ancestors.Reverse | and ($page.Param "paige.site.disable_breadcrumbs" | not) }}
{{ $description := $page.Param "paige.site.description" | markdownify | and ($page.Param "paige.site.disable_description" | not) }}
{{ $first := templates.Exists "partials/paige/site-header-first.html" }}
{{ $last := templates.Exists "partials/paige/site-header-last.html" }}
{{ $links := false }}
{{ $menu := $page.Param "paige.site.disable_menu" | not }}
{{ $pills := false }}
{{ $style := $page.Param "paige.site.menu_style" }}
{{ $tabs := false }}
{{ $title := "" }} {{/* Titolo per lingua da hugo.toml */}}
{{ with site.GetPage "/" }}{{ with .Title }}{{ $title = . | markdownify | and ($page.Param "paige.site.disable_title" | not) }}{{ end }}{{ end }}
{{ $underline := false }}

{{ with $style }}
    {{ if eq . "pills" }}{{ $pills = true }}
    {{ else if eq . "tabs" }}{{ $tabs = true }}
    {{ else if eq . "underline" }}{{ $underline = true }}
    {{ else }}{{ $links = true }}{{ end }}
{{ else }}{{ $links = true }}{{ end }}

{{ if or $breadcrumbs $description $first $last $menu $title }}
    <header id="paige-site-header">
        {{ partial "paige/func-include.html" (dict "name" "site-header-first%s.html" "page" $page) | safeHTML }}

        {{ with $title }}
            <div class="display-1 fw-bold {{ if not (or $breadcrumbs $description $menu) }} paige-row-tall {{ end }} text-center" id="paige-site-title">
                 {{ $homeURL := site.BaseURL }}
                 {{ if not (eq $.Page.Lang site.DefaultContentLanguage) }}
                     {{ $homeURL = printf "%s%s/" $homeURL $.Page.Lang }}
                 {{ else if site.Params.defaultContentLanguageInSubdir }}
                     {{ $homeURL = printf "%s%s/" $homeURL $.Page.Lang }}
                 {{ end }}
                <a class="text-body text-decoration-none" href="{{ $homeURL | safeURL }}">{{ . }}</a>
            </div>
        {{ end }}

        {{ with $description }}
            <div class="lead paige-row-tall text-center" id="paige-site-description">{{ . }}</div>
        {{ end }}

        {{ if $menu }}
            {{ $currentMenu := site.Menus.main }} 
            {{ $siteBase := site.BaseURL }} 
            {{ $currentLang := .Page.Lang }} 
            {{ $isDefaultLang := eq $currentLang site.DefaultContentLanguage }}
            {{ $defaultInSubdir := site.Params.defaultContentLanguageInSubdir }}

            {{ with $currentMenu }} 
                <nav aria-label="{{ T `paige_menu` | default "Main menu" }}" class="paige-row-tall" id="paige-site-menu">
                    <ul class="align-items-center justify-content-center nav {{ if $pills }} nav-pills {{ else if $tabs }} nav-tabs {{ else if $underline }} nav-underline {{ end }}">
                        {{ range . }}
                            {{ $menuURL := .URL }} 
                            {{ $isExternal := strings.HasPrefix $menuURL "http" }}

                            {{/* ----------- COSTRUZIONE MANUALE URL ----------- */}}
                            {{ $finalURL := "" }}
                            {{ if $isExternal }}{{ $finalURL = $menuURL }}
                            {{ else }}
                                {{ $finalURL = $siteBase }} 
                                {{ if not $isDefaultLang }}{{ $finalURL = printf "%s%s" $finalURL $currentLang }}
                                {{ else if $defaultInSubdir }}{{ $finalURL = printf "%s%s" $finalURL $currentLang }}{{ end }}
                                {{ $finalURL = printf "%s%s" ($finalURL | strings.TrimSuffix "/") $menuURL }} 
                                {{ $finalURL = $finalURL | safeURL }}
                            {{ end }}
                            {{/* ----------- FINE COSTRUZIONE MANUALE ----------- */}}

                            {{/* ***** LOGICA ATTIVA RIPRISTINATA A QUELLA STANDARD HUGO ***** */}}
                            {{ $active := false }}
                            {{ if eq .URL "/" }} 
                                {{ $active = $.Page.IsHome }} 
                            {{ else }}
                                {{/* Usiamo le funzioni interne di Hugo. Potrebbe esserci ancora il problema sulla Home, ma dovrebbe funzionare per le altre */}}
                                {{ $active = or ($.Page.IsMenuCurrent "main" .) ($.Page.HasMenuCurrent "main" .) }}
                            {{ end }}
                            {{/* ***** FINE LOGICA ATTIVA RIPRISTINATA ***** */}}

                            <li class="nav-item {{ if .Children }} dropdown {{ end }}">
                                <a {{ if $active }} aria-current="page" {{ end }} {{ if .Children }} aria-expanded="false" {{ end }} class="{{ if $active }} active {{ if $links }} fw-bold text-body {{ end }} {{ end }} {{ if .Params.paige.disabled }} disabled {{ end }} nav-link {{ if .Children }} dropdown-toggle {{ end }} {{ if $links }} text-decoration-underline {{ end }}" {{ if .Children }} data-bs-toggle="dropdown" {{ end }} href="{{ if not .Children }}{{ $finalURL }}{{ else }}#{{ end }}" {{ if .Children }} role="button" {{ end }} {{ if not .Children }}{{ if $isExternal }} target="_blank" rel="noopener noreferrer" {{ end }}{{ end }}>{{ .Name | markdownify }}</a> {{ with .Children }}
                                    <ul class="dropdown-menu">
                                        {{ range . }}
                                             {{/* Costruzione manuale URL per sottomenu */}}
                                            {{ $childURL := .URL }}
                                            {{ $childIsExternal := strings.HasPrefix $childURL "http" }}
                                            {{ $finalChildURL := "" }}
                                            {{ if $childIsExternal }}{{ $finalChildURL = $childURL }}
                                            {{ else }}
                                                {{ $finalChildURL = $siteBase }}
                                                {{ if not $isDefaultLang }}{{ $finalChildURL = printf "%s%s" $finalChildURL $currentLang }}{{ else if $defaultInSubdir }}{{ $finalChildURL = printf "%s%s" $finalChildURL $currentLang }}{{ end }}
                                                {{ $finalChildURL = printf "%s%s" ($finalChildURL | strings.TrimSuffix "/") $childURL }} 
                                                {{ $finalChildURL = $finalChildURL | safeURL }}
                                            {{ end }}
                                            <li>
                                                <a class="{{ if .Params.paige.disabled }} disabled {{ end }} dropdown-item" href="{{ $finalChildURL }}" {{ if $childIsExternal }} target="_blank" rel="noopener noreferrer" {{ end }}>{{ .Name | markdownify }}</a> </li>
                                        {{ end }}
                                    </ul>
                                {{ end }}
                            </li>
                        {{ end }} {{/* Fine range . */}}
                    </ul>
                </nav>
            {{ end }} {{/* Fine with $currentMenu */}}
        {{ end }} {{/* Fine if $menu */}}

        {{ with $breadcrumbs }}
             {{/* ... Logica breadcrumbs invariata ... */}}
             <nav aria-label="{{ T `paige_breadcrumbs` | default "Breadcrumbs" }}" class="paige-row-tall" id="paige-site-breadcrumbs">
                 <div class="d-flex justify-content-center">
                     <ol class="breadcrumb mb-0">
                         {{ range . }}
                             {{ $title := cond .IsHome (T "paige_home" | default "Home") .LinkTitle }}
                             <li class="breadcrumb-item">
                                 <a href="{{ .RelPermalink }}">{{ $title | markdownify | plainify | htmlUnescape }}</a>
                             </li>
                         {{ end }}
                     </ol>
                 </div>
             </nav>
        {{ end }}

        {{ partial "paige/func-include.html" (dict "name" "site-header-last%s.html" "page" $page) | safeHTML }}
    </header>
{{ end }} {{/* Fine if or ... */}}